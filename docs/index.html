<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0F172A">
    <meta name="description" content="WebDrop - P2P 跨平台檔案傳輸 | 加密傳輸、多種連接方式">
    <title>WebDrop - P2P 加密檔案傳輸</title>
    <link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#3B82F6"/>
                            <stop offset="100%" style="stop-color:#8B5CF6"/>
                        </linearGradient>
                    </defs>
                    <rect width="32" height="32" rx="8" fill="url(#logoGradient)"/>
                    <path d="M10 16L14 20L22 12" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>WebDrop</span>
            </div>
            <div class="header-actions">
                <div class="user-name-section">
                    <input type="text" id="userNameInput" class="user-name-input" placeholder="輸入名稱" maxlength="20" title="點擊輸入您的名稱">
                    <button class="dice-btn" id="diceBtn" title="產生隨機名稱">🎲</button>
                </div>
                <!-- P2P 狀態指示器 -->
                <div class="status-badge" style="background: var(--bg-tertiary); min-width: 110px;">
                    <span id="p2pStatusDot" style="width: 8px; height: 8px; border-radius: 50%; background: var(--text-secondary); display: inline-block; margin-right: 6px;"></span>
                    <span id="p2pStatusText" style="font-size: 11px;">P2P 初始化中...</span>
                </div>
                <!-- 流量監控指示器 -->
                <div id="trafficIndicator" class="status-badge" style="background: var(--bg-tertiary); min-width: 100px;">
                    <span style="font-size: 11px;">📊 載入中...</span>
                </div>
                <div class="status-badge">
                    <div class="status-dot"></div>
                    <span id="statusText">未連接</span>
                </div>
                <button class="icon-btn" id="settingsBtn" title="設定">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
                <button class="icon-btn" id="helpBtn" title="使用說明">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="receive">📥 接收模式</button>
                <button class="tab" data-tab="send">📤 傳送模式</button>
            </div>

            <!-- Receive Tab -->
            <div id="receiveTab" class="tab-content active">
                <!-- My Device Info -->
                <div class="card">
                    <div class="card-title">我的裝置</div>
                    <div class="card-subtitle">分享此頁面或 QR 碼讓他人傳送檔案給您</div>
                    <div class="my-device-info">
                        <div class="device-avatar">💻</div>
                        <div class="device-details">
                            <h3 id="displayName">載入中...</h3>
                            <div class="device-meta">
                                <span class="meta-item" id="deviceType">💻 電腦</span>
                                <span class="meta-item" id="browserInfo">🌐 載入中...</span>
                                <span class="meta-item" id="myToken">🔑 產生中...</span>
                            </div>
                        </div>
                        <div class="btn-group-sm">
                            <button class="btn btn-sm btn-secondary" onclick="generateNewToken()" title="產生新的連接代碼">
                                🔄 刷新
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="copyToken()" title="複製連接代碼">
                                📋 複製
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Connection Methods -->
                <div class="card">
                    <div class="card-title">連接方式</div>
                    <div class="card-subtitle">選擇一種方式讓對方連接到您的裝置</div>
                    <div class="connection-methods">
                        <button class="method-btn" onclick="switchMethod('qr')">
                            <div class="method-icon">📱</div>
                            <div class="method-info">
                                <h4>QR 碼連接</h4>
                                <p>讓對方掃描您的 QR 碼即可連接</p>
                            </div>
                        </button>
                        <button class="method-btn" onclick="switchMethod('code')">
                            <div class="method-icon">🔢</div>
                            <div class="method-info">
                                <h4>12 位連接代碼</h4>
                                <p>輸入對方提供的 12 位代碼</p>
                            </div>
                        </button>
                        <button class="method-btn" onclick="switchMethod('bluetooth')">
                            <div class="method-icon">📡</div>
                            <div class="method-info">
                                <h4>藍牙偵測</h4>
                                <p>透過藍牙自動搜尋附近裝置</p>
                            </div>
                        </button>
                        <button class="method-btn" onclick="switchMethod('ip')">
                            <div class="method-icon">🌐</div>
                            <div class="method-info">
                                <h4>內網 IP 連接</h4>
                                <p>輸入對方的內網 IP 地址</p>
                            </div>
                        </button>
                        <button class="method-btn" onclick="switchMethod('manual')">
                            <div class="method-icon">🔗</div>
                            <div class="method-info">
                                <h4>手動信令</h4>
                                <p>無伺服器也能建立 P2P 連接</p>
                            </div>
                        </button>
                        <button class="method-btn" onclick="switchMethod('server')">
                            <div class="method-icon">🖥️</div>
                            <div class="method-info">
                                <h4>伺服器連接</h4>
                                <p>連接自架信令伺服器</p>
                            </div>
                        </button>
                    </div>

                    <!-- QR Section -->
                    <div id="qrSection" class="connection-section">
                        <div class="qr-section">
                            <div id="qrCodeContainer" class="qr-canvas">
                                <div class="qr-loading">正在產生 QR 碼...</div>
                            </div>
                            <div id="myTokenDisplay" class="token-display">載入中...</div>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 12px;">對方可用相機掃描此 QR 碼，或輸入上方的 12 位代碼</p>
                        </div>
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 12px; font-size: 14px;">📷 QR 碼掃描器</h4>
                            <button id="startScannerBtn" class="btn btn-primary" onclick="startQRScanner()" style="margin-bottom: 12px;">開啟相機掃描</button>
                            <button id="stopScannerBtn" class="btn btn-danger" onclick="stopQRScanner()" style="display: none; margin-bottom: 12px;">關閉相機</button>
                            <div id="qrReader" style="width: 100%; max-width: 300px; margin: 0 auto; border-radius: var(--radius-md); overflow: hidden; display: none;"></div>
                            <div id="qrScanResult" style="margin-top: 16px; display: none;">
                                <div style="padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: 12px;">
                                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">偵測到的資料：</p>
                                    <p id="qrScannedData" style="font-family: monospace; font-size: 12px; word-break: break-all;"></p>
                                </div>
                                <button class="btn btn-primary" onclick="connectWithQRData()">✨ 連接</button>
                            </div>
                        </div>
                    </div>

                    <!-- Token Input Section -->
                    <div id="codeSection" class="connection-section">
                        <div class="token-input-section">
                            <label style="display: block; margin-bottom: 12px; font-size: 14px;">輸入對方的 12 位連接代碼</label>
                            <div class="token-input-group">
                                <input type="text" id="tokenInput" placeholder="例如：ABCD-EFGH-IJKL" maxlength="14" style="text-align: center; letter-spacing: 4px; font-size: 18px;">
                                <button class="btn btn-primary" onclick="connectWithToken()">連接</button>
                            </div>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 12px;">代碼格式：4 位字母或數字一組，共 3 組（不含 I、O、1、0）</p>
                        </div>
                    </div>

                    <!-- Bluetooth Section -->
                    <div id="bluetoothSection" class="connection-section">
                        <div class="bluetooth-section">
                            <div id="bluetoothUnsupported" style="display: none; padding: 40px 20px; text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 16px;">🚫</div>
                                <h3 style="margin-bottom: 8px;">您的瀏覽器不支援藍牙</h3>
                                <p style="color: var(--text-secondary);">請使用 Chrome、Edge 或 Opera 瀏覽器</p>
                            </div>
                            <div id="bluetoothSupported">
                                <button class="btn btn-primary" onclick="startBluetoothDetection()">🔍 搜尋附近藍牙裝置</button>
                                <div id="bluetoothProgress" class="bluetooth-progress">
                                    <div class="radar-container">
                                        <div class="radar-ring"></div>
                                        <div class="radar-ring"></div>
                                        <div class="radar-ring"></div>
                                        <div class="radar-center"></div>
                                    </div>
                                    <div class="progress-bar">
                                        <div id="btProgressFill" class="progress-bar-fill" style="width: 0%;"></div>
                                    </div>
                                    <p id="btProgressText" class="progress-text">準備中...</p>
                                </div>
                                <div id="bluetoothDevices" class="bluetooth-devices"></div>
                            </div>
                        </div>
                    </div>

                    <!-- IP Section -->
                    <div id="ipSection" class="connection-section">
                        <div class="ip-section">
                            <div class="ip-info">
                                <div class="ip-card">
                                    <div class="ip-card-label">您的內網 IP</div>
                                    <div id="localIP" class="ip-card-value">偵測中...</div>
                                </div>
                                <div class="ip-card">
                                    <div class="ip-card-label">公共 IP</div>
                                    <div id="publicIP" class="ip-card-value">偵測中...</div>
                                </div>
                            </div>
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                <label style="display: block; margin-bottom: 12px; font-size: 14px;">輸入對方的內網 IP 地址連接</label>
                                <div class="ip-input-group">
                                    <input type="text" id="lanIPInput" placeholder="例如：192.168.1.100">
                                    <button class="btn btn-primary" onclick="connectWithLANIP()">連接</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Signaling Section -->
                    <div id="manualSection" class="connection-section">
                        <div class="manual-section">
                            <div class="manual-tabs">
                                <button id="createConnectionTab" class="btn btn-primary" onclick="switchManualConnectionTab('create')">建立連接</button>
                                <button id="joinConnectionTab" class="btn btn-secondary" onclick="switchManualConnectionTab('join')">加入連接</button>
                            </div>
                            <div id="createConnectionPanel" style="margin-top: 20px;">
                                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">產生連接資料，分享給對方（無需伺服器）</p>
                                <button class="btn btn-primary" onclick="generateConnectionData()">產生連接資料</button>
                                <div id="connectionDataSection" style="display: none; margin-top: 20px;">
                                    <div id="connectionDataOutput" style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius-md); font-family: monospace; font-size: 11px; word-break: break-all; max-height: 200px; overflow-y: auto;"></div>
                                    <div class="btn-group" style="margin-top: 12px;">
                                        <button class="btn btn-secondary" onclick="copyConnectionData()">📋 複製資料</button>
                                    </div>
                                </div>
                                <div id="waitingForPeer" style="display: none; margin-top: 20px; padding: 20px; background: rgba(59, 130, 246, 0.1); border-radius: var(--radius-md); text-align: center;">
                                    <p style="margin-bottom: 12px;">⏳ 等待對方加入...</p>
                                    <button class="btn btn-secondary" onclick="cancelManualConnection()">取消等待</button>
                                </div>
                            </div>
                            <div id="joinConnectionPanel" style="display: none; margin-top: 20px;">
                                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">貼上對方提供的連接資料</p>
                                <textarea id="connectionDataInput" style="width: 100%; padding: 14px; border-radius: var(--radius-md); border: 2px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); font-family: monospace; font-size: 12px; resize: vertical; min-height: 100px; margin-bottom: 16px;" placeholder="在此貼上連接資料"></textarea>
                                <button class="btn btn-primary" onclick="joinConnection()">加入連接</button>
                                <div id="manualConnectedDevice" style="display: none; margin-top: 20px; padding: 20px; background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-md); text-align: center;">
                                    <p style="margin-bottom: 8px; font-weight: 600;">✅ 已建立連接！</p>
                                    <p id="manualDeviceName" style="font-size: 18px; font-weight: 600; margin-bottom: 8px;"></p>
                                    <p id="manualDeviceInfo" style="color: var(--text-secondary);"></p>
                                    <button class="btn btn-secondary" style="margin-top: 12px;" onclick="disconnectManualConnection()">斷開連接</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Server Section -->
                    <div id="serverSection" class="connection-section">
                        <div class="server-section">
                            <div class="server-status" id="serverStatus" style="display: none; margin-bottom: 20px; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                                <div class="server-status-icon" id="serverStatusIcon" style="width: 12px; height: 12px; border-radius: 50%; background: var(--text-secondary); margin-right: 12px;"></div>
                                <span id="serverStatusText" style="font-size: 14px;">連接中...</span>
                                <button class="btn btn-sm btn-danger" style="margin-left: auto; padding: 6px 12px; font-size: 12px;" onclick="disconnectServer()">斷開</button>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 12px; font-size: 14px;">自架伺服器地址</label>
                                <div class="ip-input-group" style="flex-direction: column;">
                                    <input type="text" id="serverInput" placeholder="wss://your-server.com 或 https://your-server.com/socket" style="width: 100%;">
                                    <div class="btn-group" style="margin-top: 12px; justify-content: flex-start;">
                                        <button class="btn btn-primary" onclick="saveServerAddress()">💾 儲存</button>
                                        <button class="btn btn-secondary" onclick="connectToServer()">🔌 連接</button>
                                        <button class="btn btn-secondary" onclick="autoDetectServer()">🔍 使用已儲存的</button>
                                    </div>
                                </div>
                                <p id="savedServerAddress" style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);">目前無預設伺服器</p>
                            </div>
                            <div id="serverDevicesSection" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                <h4 style="margin-bottom: 16px; font-size: 15px;">📡 線上裝置</h4>
                                <div id="noServerDevices" style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                                    <p style="margin-bottom: 8px;">目前沒有其他裝置連接到伺服器</p>
                                    <p style="font-size: 12px;">分享此頁面給他人以建立連接</p>
                                </div>
                                <div id="serverDevicesList" class="devices-list"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Connected Devices -->
                <div class="card">
                    <div class="card-title">已連接的裝置</div>
                    <div class="card-subtitle">與您連接的裝置列表</div>
                    <div id="connectedDevices" class="devices-list">
                        <div class="empty-state">
                            <div class="empty-icon">📡</div>
                            <h3>尚未連接任何裝置</h3>
                            <p>使用上方方法建立連接</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Send Tab -->
            <div id="sendTab" class="tab-content">
                <!-- Send File Button -->
                <div class="card">
                    <div class="card-title">傳送檔案</div>
                    <div class="card-subtitle">選擇已連接的裝置並傳送檔案</div>
                    <div class="file-area">
                        <div class="drop-zone" id="dropZone">
                            <div class="drop-zone-content">
                                <div class="drop-zone-icon">📁</div>
                                <div class="drop-zone-text">拖放檔案到這裡</div>
                                <div class="drop-zone-hint">或點擊選擇檔案</div>
                            </div>
                        </div>
                        <input type="file" id="fileInput" class="file-input" multiple>
                        <div id="fileList" class="file-list"></div>
                    </div>
                </div>

                <!-- Connected Devices for Sending -->
                <div class="card">
                    <div class="card-title">選擇接收裝置</div>
                    <div class="card-subtitle">選擇要傳送檔案的目標裝置</div>
                    <div id="sendDevices" class="devices-list">
                        <div class="empty-state">
                            <div class="empty-icon">📡</div>
                            <h3>無已連接裝置</h3>
                            <p>請先在「接收模式」建立連接</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-icon">⚙️</div>
                    <div class="modal-title">設定</div>
                    <div class="modal-subtitle">自訂您的 WebDrop 體驗</div>
                </div>

                <div class="settings-section">
                    <h4 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        安全設定
                    </h4>
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>端對端加密</label>
                            <p>使用 ECDH 金鑰交換加密所有檔案傳輸</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="encryptionToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>連接密碼</label>
                            <p>設定密碼以保護連接請求</p>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="showPasswordModal()">設定</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h4 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                        顯示設定
                    </h4>
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>動畫效果</label>
                            <p>啟用頁面載入和過場動畫</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="animationToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>音效提示</label>
                            <p>播放操作和傳輸完成音效</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="soundToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <h4 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                        進階設定
                    </h4>
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>自動接受連接</label>
                            <p>自動接受所有連接請求（不建議）</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="autoAcceptToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>清除所有資料</label>
                            <p>重置所有設定和已儲存的資料</p>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="clearAllData()">清除</button>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-primary" style="flex: 1;" onclick="saveSettings()">💾 儲存設定</button>
                    <button class="btn btn-secondary" style="flex: 1;" onclick="closeSettings()">✕ 關閉</button>
                </div>
            </div>
        </div>

        <!-- Agreement Modal -->
        <div id="agreementModal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-icon">🤝</div>
                    <div class="modal-title">連接請求</div>
                    <div class="modal-subtitle">有人想要連接到您的裝置</div>
                </div>
                <div id="requestingDevice" class="modal-device">
                    <div class="modal-device-icon">📱</div>
                    <div class="modal-device-info">
                        <h4>載入中...</h4>
                        <p>載入中...</p>
                    </div>
                </div>
                <div id="passwordSection" style="display: none; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px;">請輸入連接密碼</label>
                    <input type="password" id="connectionPassword" class="modal-input" placeholder="輸入密碼" style="text-align: center;">
                    <p id="passwordError" style="color: var(--error); font-size: 12px; display: none; margin-top: 8px;">密碼錯誤</p>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-danger" onclick="rejectConnection()">✕ 拒絕</button>
                    <button class="btn btn-primary" id="acceptBtn" onclick="acceptConnection()">✓ 接受</button>
                </div>
            </div>
        </div>

        <!-- Permission Modal -->
        <div id="btPermissionModal" class="modal-overlay">
            <div class="modal permission-modal">
                <div class="modal-header">
                    <div class="modal-icon">📡</div>
                    <div class="modal-title">藍牙權限請求</div>
                    <div class="modal-subtitle">WebDrop 需要存取您的藍牙裝置</div>
                </div>
                <div class="permission-content">
                    <h4>此權限將用於：</h4>
                    <ul>
                        <li><span class="permission-check">✓</span> 搜尋附近的藍牙裝置</li>
                        <li><span class="permission-check">✓</span> 建立藍牙連接傳輸檔案</li>
                        <li><span class="permission-check">✓</span> 自動配對已連接過的裝置</li>
                    </ul>
                    <div style="margin-top: 16px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-md); font-size: 13px;">
                        ⚠️ 注意：藍牙功能僅在 Chrome、Edge 和 Opera 瀏覽器中受支援，且必須使用 HTTPS 安全連線。
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeBtPermissionModal()">✕ 拒絕</button>
                    <button class="btn btn-primary" onclick="requestBluetoothPermission()">✓ 允許</button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="modal-overlay">
            <div class="modal" style="max-width: 600px;">
                <div class="modal-header">
                    <div class="modal-icon">❓</div>
                    <div class="modal-title">WebDrop 使用說明</div>
                    <div class="modal-subtitle">快速上手指南</div>
                </div>
                <div style="text-align: left; line-height: 1.8;">
                    <h4 style="margin: 20px 0 12px; color: var(--primary);">📱 接收模式</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 12px;">在此模式下，您是「接收者」。分享您的 QR 碼或 12 位代碼，讓他人傳送檔案給您。</p>

                    <h4 style="margin: 20px 0 12px; color: var(--primary);">📤 傳送模式</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 12px;">在此模式下，您是「傳送者」。選擇已連接的裝置，拖放或選擇檔案即可傳送。</p>

                    <h4 style="margin: 20px 0 12px; color: var(--primary);">🔐 安全傳輸</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 12px;">WebDrop 預設使用端對端加密，確保您的檔案在傳輸過程中受到保護。您也可以設定連接密碼來進一步保護您的連接。</p>

                    <h4 style="margin: 20px 0 12px; color: var(--primary);">📡 連接方式說明</h4>
                    <ul style="color: var(--text-secondary); padding-left: 20px; margin-bottom: 12px;">
                        <li style="margin-bottom: 8px;"><strong>QR 碼：</strong>最快速的方式，掃描對方的 QR 碼即可建立連接</li>
                        <li style="margin-bottom: 8px;"><strong>12 位代碼：</strong>手動輸入對方提供的代碼</li>
                        <li style="margin-bottom: 8px;"><strong>藍牙偵測：</strong>僅支援 Chrome/Edge，需要 HTTPS</li>
                        <li style="margin-bottom: 8px;"><strong>內網 IP：</strong>在同一網路下輸入對方的 IP 地址</li>
                        <li style="margin-bottom: 8px;"><strong>手動信令：</strong>無需伺服器，複製貼上連接資料即可</li>
                        <li style="margin-bottom: 8px;"><strong>伺服器連接：</strong>連接自架的 WebRTC 信令伺服器</li>
                    </ul>

                    <h4 style="margin: 20px 0 12px; color: var(--primary);">⚠️ 注意事項</h4>
                    <ul style="color: var(--text-secondary); padding-left: 20px;">
                        <li style="margin-bottom: 8px;">某些功能需要 HTTPS 連線才能使用（如相機、藍牙）</li>
                        <li style="margin-bottom: 8px;">檔案傳輸速度取決於您的網路連線品質</li>
                        <li style="margin-bottom: 8px;">請勿清除瀏覽器的 Cookie，否則連接密碼將會遺失</li>
                        <li style="margin-bottom: 8px;">若連接有問題，請嘗試刷新頁面或產生新的連接代碼</li>
                    </ul>
                </div>
                <div class="modal-actions" style="margin-top: 24px;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="closeHelp()">✓ 了解了</button>
                </div>
            </div>
        </div>

        <!-- Password Modal -->
        <div id="passwordModal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-icon">🔒</div>
                    <div class="modal-title">連接密碼</div>
                    <div class="modal-subtitle">設定或輸入連接密碼</div>
                </div>
                <div id="setPasswordSection">
                    <input type="password" id="newPassword" class="modal-input" placeholder="輸入新密碼（4-20 位）" style="text-align: center; margin-bottom: 12px;">
                    <input type="password" id="confirmPassword" class="modal-input" placeholder="確認密碼" style="text-align: center;">
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 12px;">密碼將加密儲存在 Cookies 中</p>
                </div>
                <div id="enterPasswordSection" style="display: none;">
                    <input type="password" id="enterPassword" class="modal-input" placeholder="輸入連接密碼" style="text-align: center;">
                    <p id="passwordMismatch" style="color: var(--error); font-size: 12px; display: none; margin-top: 8px;">密碼錯誤</p>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancelPasswordBtn" onclick="closePasswordModal()">✕ 取消</button>
                    <button class="btn btn-primary" id="submitPasswordBtn" onclick="submitPassword()">✓ 確認</button>
                </div>
            </div>
        </div>

        <!-- Clear Data Confirmation Modal -->
        <div id="clearDataModal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-icon" style="background: linear-gradient(135deg, var(--error), #DC2626);">⚠️</div>
                    <div class="modal-title">確認清除</div>
                    <div class="modal-subtitle">此操作無法復原</div>
                </div>
                <p style="text-align: center; margin-bottom: 20px;">確定要清除所有設定和已儲存的資料嗎？這將包括：</p>
                <ul style="text-align: left; margin-bottom: 24px; padding-left: 20px;">
                    <li>儲存的伺服器地址</li>
                    <li>連接密碼</li>
                    <li>所有 Cookies 資料</li>
                </ul>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeClearDataModal()">✕ 取消</button>
                    <button class="btn btn-danger" onclick="confirmClearData()">🗑️ 確定清除</button>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toastContainer"></div>

        <!-- Drop Overlay -->
        <div id="dropOverlay" class="drop-overlay">
            <div class="drop-overlay-content">
                <div class="drop-overlay-icon">📥</div>
                <div class="drop-overlay-text">釋放以傳送檔案</div>
                <div class="drop-overlay-hint">將檔案拖放到此處</div>
            </div>
        </div>

        <!-- Background Effects -->
        <div class="bg-effects">
            <div class="bg-gradient-orb orb-1"></div>
            <div class="bg-gradient-orb orb-2"></div>
            <div class="bg-gradient-orb orb-3"></div>
        </div>
    </div>

    <!-- Local Libraries -->
    <script src="assets/libs/qrcode.min.js"></script>
    <script src="assets/libs/html5-qrcode.min.js"></script>
    <script src="assets/libs/trystero-p2p.js"></script>
    <script src="assets/js/app.js"></script>
</body>
</html>